<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>West Bengal Interactive Tourism Map</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root {
      --primary: #2563eb; 
      --primary-dark: #1d4ed8;
      --secondary: #f59e0b;
      --dark: #0f172a;
      --dark-light: #1e293b;
      --text: #f8fafc;
      --text-light: #cbd5e1;
      --border: #334155;
      --card-bg: rgba(30, 41, 59, 0.7);
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      --radius: 12px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: var(--dark);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    /* Background with gradient */
    .background-gradient {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--dark) 0%, #1e1b4b 100%);
      z-index: -2;
    }
    
    .background-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232563eb' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      z-index: -1;
    }
    
    /* Main layout */
    .app-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      padding: 24px;
      height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* Side panel */
    .side-panel {
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .brand-section {
      display: flex;
      align-items: center;
      gap: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 20px;
    }
    
    .brand-text h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .brand-text p {
      font-size: 14px;
      color: var(--text-light);
    }
    
    .search-container {
      display: flex;
      gap: 12px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }
    
    .search-btn, .locate-btn {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .search-btn:hover, .locate-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .filters-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .filter-chip {
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      color: var(--text-light);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-chip:hover {
      background: rgba(37, 99, 235, 0.1);
      border-color: var(--primary);
      color: var(--text);
    }
    
    .filter-chip.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Routing Section Styles */
    .routing-section {
      background: rgba(15, 23, 42, 0.4);
      border-radius: 10px;
      padding: 16px;
      border: 1px solid var(--border);
    }
    
    .input-group {
      margin-bottom: 16px;
      position: relative;
    }
    
    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-light);
    }
    
    .input-with-button {
      display: flex;
      gap: 8px;
    }
    
    .route-input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text);
      font-size: 14px;
      transition: all 0.2s;
      padding-right: 36px;
    }
    
    .route-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    .locate-input-btn {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .locate-input-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .clear-input-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .clear-input-btn:hover {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .route-calculate-btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
      transition: all 0.2s;
      margin-bottom: 8px;
    }
    
    .route-calculate-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .route-calculate-btn:disabled {
      background: var(--border);
      cursor: not-allowed;
      transform: none;
    }
    
    .route-clear-btn {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-light);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .route-clear-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-color: #ef4444;
    }
    
    /* Enhanced popup with routing */
    .enhanced-popup {
      min-width: 280px;
    }
    
    .popup-routing {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .popup-routing-btn {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--primary);
      background: transparent;
      color: var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .popup-routing-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    .poi-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      overflow-y: auto;
    }
    
    .poi-card {
      display: flex;
      gap: 16px;
      padding: 16px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .poi-card:hover {
      background: rgba(37, 99, 235, 0.1);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .poi-image {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .poi-content {
      flex: 1;
    }
    
    .poi-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .poi-desc {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 6px;
    }
    
    .poi-district {
      font-size: 12px;
      color: var(--secondary);
      font-weight: 500;
    }
    
    /* Map container */
    .map-container {
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    /* Route Preview Panel */
    .route-preview-container {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 300px;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
      display: none;
    }

    .route-preview-container.active {
      display: block;
    }

    .route-preview-container h4 {
      margin-bottom: 12px;
      font-size: 16px;
      color: var(--text);
    }

    .route-preview {
      width: 100%;
      height: 200px;
      background: var(--dark-light);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin-bottom: 12px;
      position: relative;
    }

    .route-preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-light);
      text-align: center;
      padding: 20px;
    }

    .route-preview-placeholder svg {
      margin-bottom: 10px;
      opacity: 0.5;
    }

    .route-preview-map {
      width: 100%;
      height: 100%;
    }

    .route-preview-actions {
      display: flex;
      gap: 8px;
    }

    .route-preview-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-light);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .route-preview-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* Custom popup style */
    .leaflet-popup-content-wrapper {
      background: var(--dark-light);
      color: var(--text);
      border-radius: 10px;
      box-shadow: var(--shadow);
    }
    
    .leaflet-popup-content {
      margin: 12px 16px;
      line-height: 1.5;
    }
    
    .leaflet-popup-tip {
      background: var(--dark-light);
    }
    
    /* Marker pulse animation */
    .pulse-marker {
      width: 20px;
      height: 20px;
      margin-left: -10px;
      margin-top: -10px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 0 rgba(37, 99, 235, 0.7);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
      }
      70% {
        box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }
    
    /* Custom marker cluster styles */
    .marker-cluster-small {
      background-color: rgba(37, 99, 235, 0.6) !important;
    }
    .marker-cluster-small div {
      background-color: rgba(37, 99, 235, 0.8) !important;
      color: white !important;
    }
    
    .marker-cluster-medium {
      background-color: rgba(245, 158, 11, 0.6) !important;
    }
    .marker-cluster-medium div {
      background-color: rgba(245, 158, 11, 0.8) !important;
      color: white !important;
    }
    
    .marker-cluster-large {
      background-color: rgba(239, 68, 68, 0.6) !important;
    }
    .marker-cluster-large div {
      background-color: rgba(239, 68, 68, 0.8) !important;
      color: white !important;
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Address suggestions dropdown */
    .address-suggestions {
      position: absolute;
      z-index: 1000;
      width: calc(100% - 40px);
      max-height: 200px;
      overflow-y: auto;
      background: var(--dark-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      box-shadow: var(--shadow);
      margin-top: 2px;
    }
    
    .address-suggestion {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .address-suggestion:hover {
      background: var(--primary);
      color: white;
    }
    
    .address-suggestion:last-child {
      border-bottom: none;
    }
    
    /* Responsive design */
    @media (max-width: 1024px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        gap: 16px;
        padding: 16px;
      }
      
      .side-panel {
        max-height: 40vh;
      }
      
      .route-preview-container {
        position: relative;
        top: auto;
        right: auto;
        width: 100%;
        margin-top: 16px;
      }
    }
    
    @media (max-width: 640px) {
      .app-container {
        padding: 12px;
      }
      
      .side-panel {
        padding: 16px;
      }
      
      .search-container {
        flex-direction: column;
      }
      
      .search-btn, .locate-btn {
        width: 100%;
      }
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="background-gradient"></div>
  <div class="background-overlay"></div>
  
  <div class="app-container">
    <div class="side-panel">
      <div class="brand-section">
        <div class="logo">WB</div>
        <div class="brand-text">
          <h1>West Bengal Tourism</h1>
          <p>Interactive map of heritage, nature & culture</p>
        </div>
      </div>
      
      <div class="search-container">
        <input type="text" class="search-input" id="searchBox" placeholder="Search places or districts...">
        <button class="search-btn" id="searchBtn" title="Search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 21L16.514 16.506L21 21ZM19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="locate-btn" id="locateBtn" title="Go to my location">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
      
      <div class="filters-section">
        <div class="filter-chip active" data-filter="all">All Places</div>
        <div class="filter-chip" data-filter="heritage">Heritage</div>
        <div class="filter-chip" data-filter="nature">Nature</div>
        <div class="filter-chip" data-filter="hill">Hill Stations</div>
        <div class="filter-chip" data-filter="beach">Beaches</div>
        <div class="filter-chip" data-filter="religious">Religious</div>
      </div>
      
      <!-- Routing Section -->
      <div class="routing-section">
        <h3 style="margin-bottom: 12px; font-size: 16px; color: var(--text);">Route Planner</h3>
        
        <div class="route-inputs">
          <div class="input-group">
            <label>From (Your Location)</label>
            <div class="input-with-button">
              <input type="text" class="route-input" id="routeFrom" placeholder="Current location or address">
              <button class="clear-input-btn" id="clearFromBtn" title="Clear" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="locate-input-btn" id="locateFromBtn" title="Use my location">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="input-group">
            <label>To (Destination)</label>
            <div class="input-with-button">
              <input type="text" class="route-input" id="routeTo" placeholder="Search destination...">
              <button class="clear-input-btn" id="clearToBtn" title="Clear" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          
          <button class="route-calculate-btn" id="findRouteBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            <span>Find Route</span>
          </button>
          
          <button class="route-clear-btn" id="clearRoute" style="display: none;">
            Clear Route
          </button>
        </div>
      </div>
      
      <div class="poi-list" id="poiList">
        <!-- POI list will be populated by JavaScript -->
      </div>
    </div>
    
    <div class="map-container">
      <div id="map"></div>
      
      <!-- Route Preview Panel -->
      <div class="route-preview-container" id="routePreviewContainer">
        <h4>Route Preview</h4>
        <div class="route-preview" id="routePreview">
          <div class="route-preview-placeholder">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="currentColor"/>
            </svg>
            <p>Route preview will appear here after calculation</p>
          </div>
        </div>
        <div class="route-preview-actions">
          <button class="route-preview-btn" id="openInMapsBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2"/>
              <path d="M12 13C13.6569 13 15 11.6569 15 10C15 8.34315 13.6569 7 12 7C10.3431 7 9 8.34315 9 10C9 11.6569 10.3431 13 12 13Z" stroke="currentColor" stroke-width="2"/>
            </svg>
            Open in Google Maps
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster-src.js"></script>

  <script>
    // Enhanced sample POIs for West Bengal with district information
    const POIS = [
      {id:1,name:"Victoria Memorial, Kolkata",lat:22.5448,lng:88.3426,cat:"heritage",desc:"Iconic white-marble monument and museum in Kolkata.",img:"https://upload.wikimedia.org/wikipedia/commons/1/15/Victoria_Memorial_2018.jpg",district:"Kolkata"},
      {id:2,name:"Darjeeling - Tiger Hill",lat:27.0043,lng:88.2586,cat:"hill",desc:"Sunrise viewpoint with Kanchenjunga panorama.",img:"https://upload.wikimedia.org/wikipedia/commons/3/3f/Tiger_Hill%2C_Darjeeling.jpg",district:"Darjeeling"},
      {id:3,name:"Sundarbans National Park",lat:21.9497,lng:88.8903,cat:"nature",desc:"Largest mangrove forest‚ÄîRoyal Bengal Tigers & rich biodiversity.",img:"https://upload.wikimedia.org/wikipedia/commons/4/40/Sundarban.jpg",district:"South 24 Parganas"},
      {id:4,name:"Hazarduari Palace, Murshidabad",lat:24.1850,lng:88.2655,cat:"heritage",desc:"Grand Nawabi palace with a thousand doors.",img:"https://upload.wikimedia.org/wikipedia/commons/8/88/Hazarduari_Palace_2.jpg",district:"Murshidabad"},
      {id:5,name:"Shantiniketan (Bolpur)",lat:23.6846,lng:87.6804,cat:"heritage",desc:"Tagore's university town ‚Äî culture, festivals, art.",img:"https://upload.wikimedia.org/wikipedia/commons/6/69/Shantiniketan.jpg",district:"Birbhum"},
      {id:6,name:"Digha Beach",lat:21.6346,lng:87.5008,cat:"beach",desc:"Popular seaside resort with long sandy beaches.",img:"https://upload.wikimedia.org/wikipedia/commons/9/98/Digha_beach.jpg",district:"Purba Medinipur"},
      {id:7,name:"Dakshineswar Kali Temple",lat:22.6009,lng:88.3634,cat:"religious",desc:"Famous 19th-century Kali temple on the Hooghly river.",img:"https://upload.wikimedia.org/wikipedia/commons/2/20/Dakshineswar_Kali_Temple.jpg",district:"North 24 Parganas"},
      {id:8,name:"Kalimpong",lat:27.0593,lng:88.4719,cat:"hill",desc:"Scenic hill station with Buddhist monasteries.",img:"https://upload.wikimedia.org/wikipedia/commons/6/6c/Kalimpong_Town.jpg",district:"Kalimpong"},
      {id:9,name:"Bishnupur",lat:23.0731,lng:87.3197,cat:"heritage",desc:"Famous for terracotta temples and Baluchari sarees.",img:"https://upload.wikimedia.org/wikipedia/commons/4/4b/Rasmancha%2C_Bishnupur.jpg",district:"Bankura"},
      {id:10,name:"Jaldapara National Park",lat:26.6175,lng:89.3758,cat:"nature",desc:"Wildlife sanctuary famous for Indian rhinoceros.",img:"https://upload.wikimedia.org/wikipedia/commons/e/e3/Jaldapara_Rhino.jpg",district:"Alipurduar"},
      {id:11,name:"Science City, Kolkata",lat:22.5605,lng:88.3889,cat:"heritage",desc:"Large science museum and popular tourist attraction.",img:"https://upload.wikimedia.org/wikipedia/commons/3/3d/Science_City_Kolkata.jpg",district:"Kolkata"},
      {id:12,name:"Howrah Bridge",lat:22.5853,lng:88.3472,cat:"heritage",desc:"Iconic cantilever bridge over the Hooghly River.",img:"https://upload.wikimedia.org/wikipedia/commons/6/6c/Howrah_Bridge_2017.jpg",district:"Howrah"},
      {id:13,name:"Cooch Behar Palace",lat:26.3236,lng:89.4542,cat:"heritage",desc:"Inspired by Buckingham Palace, built by Maharaja Nripendra Narayan.",img:"https://upload.wikimedia.org/wikipedia/commons/4/4f/Cooch_Behar_Palace_2012.jpg",district:"Cooch Behar"},
      {id:14,name:"Gorumara National Park",lat:26.7000,lng:88.8000,cat:"nature",desc:"Famous for Indian rhinoceros and rich biodiversity.",img:"https://upload.wikimedia.org/wikipedia/commons/4/48/Gorumara_Forest.jpg",district:"Jalpaiguri"},
      {id:15,name:"Malancha Beach",lat:21.6000,lng:87.6000,cat:"beach",desc:"Beautiful beach near Digha with red crabs.",img:"https://upload.wikimedia.org/wikipedia/commons/b/b5/Malancha_Beach.jpg",district:"Purba Medinipur"}
    ];

    // Initialize map
    const map = L.map('map', {zoomControl:false}).setView([23.6,87.4],7);
    L.control.zoom({position:'bottomright'}).addTo(map);

    // Dark basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{
      maxZoom:19,
      attribution:'&copy; OpenStreetMap contributors &copy; CARTO'
    }).addTo(map);

    // Global variables
    let districtLayer = null;
    let currentDistrictFilter = null;
    let clickTimeout = null;
    let isDistrictLoading = false;
    let currentRoute = null;
    let addressSuggestions = [];
    let routePreviewMap = null;

    // Improved helper function to normalize district names for comparison
    function normalizeDistrictName(name) {
      return name.toLowerCase().trim().replace(/\s+/g, ' ').replace(/[^a-z0-9\s]/g, '');
    }

    // Function to show loading state
    function showLoading(message = 'Loading...') {
      const loadingEl = document.createElement('div');
      loadingEl.id = 'loading-notification';
      loadingEl.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--dark-light);border-radius:8px;border:1px solid var(--border)">
          <div class="loading-spinner"></div>
          <span>${message}</span>
        </div>
      `;
      loadingEl.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        animation: slideInDown 0.3s ease;
      `;
      document.body.appendChild(loadingEl);
      return loadingEl;
    }

    // Function to hide loading
    function hideLoading() {
      const loadingEl = document.getElementById('loading-notification');
      if (loadingEl) {
        loadingEl.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => loadingEl.remove(), 300);
      }
    }

    // Function to show notification
    function showNotification(message, type = 'info') {
      // Remove existing notification
      const existingNotification = document.querySelector('.district-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = 'district-notification';
      notification.innerHTML = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : 'var(--primary)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        z-index: 1000;
        font-size: 14px;
        font-weight: 500;
        animation: slideIn 0.3s ease;
        max-width: 300px;
      `;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Enhanced image error handler
    function handleImageError(img) {
      img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA4MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjMzM0MTU1Ii8+Cjx0ZXh0IHg9IjQwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjN0Y4Q0FBIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPgo=';
      img.onerror = null; // Prevent infinite loop
    }

    // Throttled click handler for performance
    function throttleClick(callback, delay = 300) {
      return function(...args) {
        if (clickTimeout) clearTimeout(clickTimeout);
        clickTimeout = setTimeout(() => callback.apply(this, args), delay);
      };
    }

    // Load district boundaries from GeoJSON with fallback
    function loadDistrictBoundaries() {
      if (isDistrictLoading) return;
      
      isDistrictLoading = true;
      const loadingEl = showLoading('Loading district boundaries...');

      // Try multiple GeoJSON sources with fallback
      const geoJsonUrls = [
        'https://raw.githubusercontent.com/bd805672-eng/API751629/main/WEST%20BENGAL_DISTRICTS.geojson',
        'https://raw.githubusercontent.com/Subhrajit97/GeoJSON-Data-of-Indian-States/master/West_Bengal/West_Bengal.json'
      ];

      let currentUrlIndex = 0;

      function tryNextUrl() {
        if (currentUrlIndex >= geoJsonUrls.length) {
          // All URLs failed
          hideLoading();
          isDistrictLoading = false;
          showNotification('District boundaries unavailable. Using POI markers only.', 'error');
          return;
        }

        fetch(geoJsonUrls[currentUrlIndex])
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            hideLoading();
            isDistrictLoading = false;
            addDistrictLayer(data);
            showNotification('District boundaries loaded successfully');
          })
          .catch(error => {
            console.warn(`Failed to load from ${geoJsonUrls[currentUrlIndex]}:`, error);
            currentUrlIndex++;
            tryNextUrl();
          });
      }

      tryNextUrl();
    }

    // Add district layer to map
    function addDistrictLayer(data) {
      districtLayer = L.geoJSON(data, {
        style: {
          fillColor: 'rgba(37, 99, 235, 0.1)',
          weight: 2,
          opacity: 0.7,
          color: '#2563eb',
          fillOpacity: 0.1
        },
        onEachFeature: function(feature, layer) {
          // Add popup with district name
          if (feature.properties && feature.properties.DISTRICT) {
            layer.bindPopup(`
              <div style="min-width: 200px">
                <h3 style="margin: 0 0 8px; color: var(--text)">${feature.properties.DISTRICT} District</h3>
                <p style="margin: 0; color: var(--text-light); font-size: 14px">
                  Click to view tourism places in ${feature.properties.DISTRICT} district
                </p>
                <button onclick="filterByDistrict('${feature.properties.DISTRICT}')" 
                  style="margin-top: 10px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%">
                  Show Tourism Places
                </button>
              </div>
            `);
            
            // Add throttled click event
            layer.on('click', throttleClick(function(e) {
              const districtName = feature.properties.DISTRICT;
              filterByDistrict(districtName);
              document.getElementById('searchBox').value = districtName;
            }));
          }
          
          // Add hover effects
          layer.on('mouseover', function() {
            this.setStyle({
              weight: 3,
              opacity: 1,
              color: '#3b82f6',
              fillOpacity: 0.2
            });
          });
          layer.on('mouseout', function() {
            if (currentDistrictFilter !== feature.properties.DISTRICT) {
              this.setStyle({
                weight: 2,
                opacity: 0.7,
                color: '#2563eb',
                fillOpacity: 0.1
              });
            }
          });
        }
      }).addTo(map);
    }

    // Function to filter POIs by district
    function filterByDistrict(districtName) {
      currentDistrictFilter = districtName;
      
      // Filter POIs by district using normalized names for comparison
      const districtPOIs = POIS.filter(poi => 
        normalizeDistrictName(poi.district) === normalizeDistrictName(districtName)
      );
      
      // Clear all markers
      markers.clearLayers();
      
      // Add only POIs from this district
      districtPOIs.forEach(p => markers.addLayer(markerMap[p.id]));
      
      // Update the POI list
      renderFilteredList(districtPOIs);
      
      // Highlight the district
      if (districtLayer) {
        let foundDistrict = false;
        districtLayer.eachLayer(function(layer) {
          if (layer.feature && layer.feature.properties && layer.feature.properties.DISTRICT) {
            const layerDistrictName = layer.feature.properties.DISTRICT;
            if (normalizeDistrictName(layerDistrictName) === normalizeDistrictName(districtName)) {
              // Zoom to the bounds of this district
              map.fitBounds(layer.getBounds().pad(0.1));
              layer.setStyle({
                weight: 4,
                opacity: 1,
                color: '#60a5fa',
                fillColor: 'rgba(37, 99, 235, 0.3)',
                fillOpacity: 0.3
              });
              layer.openPopup();
              foundDistrict = true;
            } else {
              layer.setStyle({
                weight: 1,
                opacity: 0.3,
                color: '#2563eb',
                fillColor: 'rgba(37, 99, 235, 0.05)',
                fillOpacity: 0.05
              });
            }
          }
        });
        
        if (!foundDistrict) {
          console.warn(`District "${districtName}" not found in boundaries`);
        }
      }
      
      // Update filter chips to show "All" as active
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
      
      // Show notification
      showNotification(`Showing ${districtPOIs.length} tourism places in ${districtName}`);
    }

    // Function to reset district styles
    function resetDistrictStyles() {
      if (districtLayer) {
        districtLayer.eachLayer(function(layer) {
          layer.setStyle({
            weight: 2,
            opacity: 0.7,
            color: '#2563eb',
            fillColor: 'rgba(37, 99, 235, 0.1)',
            fillOpacity: 0.1
          });
        });
      }
    }

    // Function to reset to default view
    function resetToDefaultView() {
      markers.clearLayers();
      POIS.forEach(p => markers.addLayer(markerMap[p.id]));
      renderList('all');
      map.setView([23.6,87.4],7);
      currentDistrictFilter = null;
      resetDistrictStyles();
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelector('.filter-chip[data-filter="all"]').classList.add('active');
    }

    // Function to render filtered list
    function renderFilteredList(poiArray) {
      const poiList = document.getElementById('poiList');
      poiList.innerHTML = '';
      
      if (poiArray.length === 0) {
        poiList.innerHTML = `
          <div style="text-align:center;padding:30px;color:var(--text-light)">
            <div style="font-size:48px;margin-bottom:10px">üèûÔ∏è</div>
            <p>No tourism places found.</p>
            <p style="font-size:12px;margin-top:8px">Try a different search or filter</p>
          </div>`;
        return;
      }
      
      poiArray.forEach(p => {
        const el = document.createElement('div'); 
        el.className = 'poi-card';
        el.innerHTML = `
          <img src='${p.img}' alt='${p.name}' class='poi-image' onerror="handleImageError(this)">
          <div class='poi-content'>
            <h3 class='poi-title'>${p.name}</h3>
            <p class='poi-desc'>${p.desc}</p>
            <div class='poi-district'>${p.district} District ‚Ä¢ ${p.cat.charAt(0).toUpperCase() + p.cat.slice(1)}</div>
          </div>
        `;
        el.addEventListener('click', throttleClick(() => {
          map.setView([p.lat, p.lng], 13); 
          markerMap[p.id].openPopup();
          setAsDestination(p.id);
        }));
        poiList.appendChild(el);
      });
    }

    // Marker cluster group
    const markers = L.markerClusterGroup({
      chunkedLoading: true,
      maxClusterRadius: 50
    });

    // Custom div icon
    function createIcon(){
      return L.divIcon({className:'custom-marker',html:'<div class="pulse-marker"></div>',iconSize:[20,20]});
    }

    const poiById = {};
    POIS.forEach(p=>{poiById[p.id]=p});

    // Create enhanced popup with routing option
    function createEnhancedPopup(p) {
      return `
        <div class="enhanced-popup">
          <h3 style='margin:0 0 6px;color:var(--text)'>${p.name}</h3>
          <img src='${p.img}' style='width:100%;height:120px;object-fit:cover;border-radius:8px;margin-bottom:8px' onerror="handleImageError(this)"/>
          <p style='margin:0;font-size:13px;color:var(--text-light)'>${p.desc}</p>
          <p style='margin:4px 0;font-size:12px;color:var(--secondary)'><strong>District:</strong> ${p.district}</p>
          <p style='margin:4px 0;font-size:12px;color:var(--text-light)'><strong>Category:</strong> ${p.cat.charAt(0).toUpperCase() + p.cat.slice(1)}</p>
          <div class="popup-routing">
            <button class="popup-routing-btn" onclick="setAsDestination(${p.id})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L12 22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M17 7L12 2L7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 17L12 22L17 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Set as Destination
            </button>
          </div>
          <p style='margin:8px 0 0'>
            <a target='_blank' href='https://www.google.com/search?q=${encodeURIComponent(p.name+" west bengal")}' style='color:var(--primary);text-decoration:none;font-weight:500'>More info ‚Üó</a>
          </p>
        </div>
      `;
    }

    // Add markers
    const markerMap = {};
    POIS.forEach(p=>{
      const m = L.marker([p.lat,p.lng],{icon:createIcon()});
      m.bindPopup(createEnhancedPopup(p),{maxWidth:300});
      m.options.category = p.cat;
      markers.addLayer(m);
      markerMap[p.id] = m;
    });
    map.addLayer(markers);

    // Build POI list in side panel
    const poiList = document.getElementById('poiList');
    function renderList(filter){
      poiList.innerHTML = '';
      const list = POIS.filter(p => filter==='all' ? true : p.cat===filter);
      list.forEach(p=>{
        const el = document.createElement('div'); 
        el.className='poi-card';
        el.innerHTML = `
          <img src='${p.img}' alt='${p.name}' class='poi-image' onerror="handleImageError(this)">
          <div class='poi-content'>
            <h3 class='poi-title'>${p.name}</h3>
            <p class='poi-desc'>${p.desc}</p>
            <div class='poi-district'>${p.district} District ‚Ä¢ ${p.cat.charAt(0).toUpperCase() + p.cat.slice(1)}</div>
          </div>
        `;
        el.addEventListener('click', throttleClick(()=>{
          map.setView([p.lat,p.lng],13); 
          markerMap[p.id].openPopup();
          setAsDestination(p.id);
        }));
        poiList.appendChild(el);
      });
      if(list.length===0) poiList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light)">No results found.</div>';
    }
    renderList('all');

    // Filter buttons
    document.querySelectorAll('.filter-chip').forEach(chip=>{
      chip.addEventListener('click', throttleClick(()=>{
        document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
        chip.classList.add('active');
        const f = chip.dataset.filter;
        
        // Reset district filter when category filter is used
        currentDistrictFilter = null;
        resetDistrictStyles();
        
        // show/hide markers based on category
        markers.clearLayers();
        POIS.filter(p=> f==='all' ? true : p.cat===f).forEach(p=>markers.addLayer(markerMap[p.id]));
        renderList(f);
      }));
    });

    // Enhanced search function for both POIs and Districts
    const searchBox = document.getElementById('searchBox');
    const searchBtn = document.getElementById('searchBtn');
    
    searchBox.addEventListener('keydown', (e)=>{if(e.key==='Enter'){doSearch();}});
    searchBtn.addEventListener('click', doSearch);
    
    function doSearch(){
      const q = searchBox.value.trim().toLowerCase();
      
      // Clear previous search results
      markers.clearLayers();
      
      if(!q){
        resetToDefaultView();
        return;
      }
      
      // Search for exact district match first
      const exactDistrictMatch = POIS.find(p => 
        normalizeDistrictName(p.district) === normalizeDistrictName(q)
      );
      
      if (exactDistrictMatch) {
        filterByDistrict(exactDistrictMatch.district);
        return;
      }
      
      // Search in POIs
      const poiResults = POIS.filter(p => 
        p.name.toLowerCase().includes(q) || 
        p.desc.toLowerCase().includes(q) ||
        normalizeDistrictName(p.district).includes(normalizeDistrictName(q)) ||
        p.cat.toLowerCase().includes(q)
      );
      
      if (poiResults.length > 0) {
        // If POI is found, show only those POIs
        poiResults.forEach(p=>markers.addLayer(markerMap[p.id]));
        renderFilteredList(poiResults);
        if(poiResults[0]) {
          map.setView([poiResults[0].lat,poiResults[0].lng],12);
          markerMap[poiResults[0].id].openPopup();
        }
        
        // Reset district styles
        resetDistrictStyles();
        currentDistrictFilter = null;
      } else {
        // No results
        renderFilteredList([]);
        
        // Reset district styles
        resetDistrictStyles();
        currentDistrictFilter = null;
        
        // Show a message
        showNotification('No places or districts found matching your search.', 'error');
      }
    }

    // Locate button
    document.getElementById('locateBtn').addEventListener('click', throttleClick(()=>{
      if(!navigator.geolocation){
        showNotification('Geolocation not supported by your browser', 'error');
        return;
      }
      
      const loading = showLoading('Finding your location...');
      
      navigator.geolocation.getCurrentPosition(
        pos=>{
          hideLoading();
          const c=pos.coords;
          map.setView([c.latitude,c.longitude],12);
          L.circle([c.latitude,c.longitude],{
            radius:80,
            fillOpacity:0.12,
            weight:0,
            color:'#2563eb'
          }).addTo(map);
          showNotification('Location found! Showing your current position.');
        },
        err=>{
          hideLoading();
          showNotification('Unable to fetch your location. Please check permissions.', 'error');
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }));

    // Address geocoding and routing functionality
    function initRouting() {
      // Set up locate button for "From" field
      document.getElementById('locateFromBtn').addEventListener('click', function() {
        if (!navigator.geolocation) {
          showNotification('Geolocation not supported by your browser', 'error');
          return;
        }

        const loading = showLoading('Getting your location...');
        
        navigator.geolocation.getCurrentPosition(
          pos => {
            hideLoading();
            const coords = pos.coords;
            
            // Try to get address from coordinates (reverse geocoding)
            getAddressFromCoords(coords.latitude, coords.longitude)
              .then(address => {
                document.getElementById('routeFrom').value = address;
                updateClearButtonVisibility('routeFrom', 'clearFromBtn');
              })
              .catch(() => {
                document.getElementById('routeFrom').value = `Current Location (${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)})`;
                updateClearButtonVisibility('routeFrom', 'clearFromBtn');
              });
            
            // Store coordinates for routing
            window.currentLocation = {
              lat: coords.latitude,
              lng: coords.longitude
            };
            
            showNotification('Location set as starting point');
          },
          err => {
            hideLoading();
            showNotification('Unable to fetch your location. Please check permissions.', 'error');
          }
        );
      });

      // Set up clear buttons for "From" and "To" fields
      document.getElementById('clearFromBtn').addEventListener('click', function() {
        document.getElementById('routeFrom').value = '';
        window.currentLocation = null;
        updateClearButtonVisibility('routeFrom', 'clearFromBtn');
      });
      
      document.getElementById('clearToBtn').addEventListener('click', function() {
        document.getElementById('routeTo').value = '';
        window.currentDestination = null;
        updateClearButtonVisibility('routeTo', 'clearToBtn');
      });

      // Set up address suggestions for "From" field
      const routeFromInput = document.getElementById('routeFrom');
      let suggestionTimeout;
      
      routeFromInput.addEventListener('input', function() {
        clearTimeout(suggestionTimeout);
        const query = this.value.trim();
        updateClearButtonVisibility('routeFrom', 'clearFromBtn');
        
        if (query.length < 3) {
          hideAddressSuggestions();
          return;
        }
        
        suggestionTimeout = setTimeout(() => {
          getAddressSuggestions(query);
        }, 300);
      });
      
      routeFromInput.addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length >= 3) {
          getAddressSuggestions(query);
        }
      });
      
      // Set up destination field
      const routeToInput = document.getElementById('routeTo');
      routeToInput.addEventListener('input', function() {
        updateClearButtonVisibility('routeTo', 'clearToBtn');
      });
      
      // Hide suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.route-input') && !e.target.closest('.address-suggestions')) {
          hideAddressSuggestions();
        }
      });

      // Set up route calculation
      document.getElementById('findRouteBtn').addEventListener('click', findRoute);
      document.getElementById('clearRoute').addEventListener('click', clearRoute);

      // Set up route preview actions
      document.getElementById('openInMapsBtn').addEventListener('click', openInGoogleMaps);
    }

    // Function to update clear button visibility
    function updateClearButtonVisibility(inputId, buttonId) {
      const inputValue = document.getElementById(inputId).value.trim();
      const button = document.getElementById(buttonId);
      
      if (inputValue.length > 0) {
        button.style.display = 'flex';
      } else {
        button.style.display = 'none';
      }
    }

    // Get address suggestions using Nominatim API (all over India)
    function getAddressSuggestions(query) {
      const loading = showLoading('Searching addresses...');
      
      // Search all over India, not just West Bengal
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', India')}&limit=5`)
        .then(response => response.json())
        .then(data => {
          hideLoading();
          addressSuggestions = data;
          showAddressSuggestions(data);
        })
        .catch(error => {
          hideLoading();
          console.error('Error fetching address suggestions:', error);
        });
    }

    // Show address suggestions dropdown
    function showAddressSuggestions(suggestions) {
      hideAddressSuggestions();
      
      if (suggestions.length === 0) return;
      
      const container = document.querySelector('.input-with-button');
      const suggestionsEl = document.createElement('div');
      suggestionsEl.className = 'address-suggestions';
      
      suggestions.forEach((suggestion, index) => {
        const suggestionEl = document.createElement('div');
        suggestionEl.className = 'address-suggestion';
        suggestionEl.textContent = suggestion.display_name;
        suggestionEl.addEventListener('click', () => {
          document.getElementById('routeFrom').value = suggestion.display_name;
          window.currentLocation = {
            lat: parseFloat(suggestion.lat),
            lng: parseFloat(suggestion.lon)
          };
          updateClearButtonVisibility('routeFrom', 'clearFromBtn');
          hideAddressSuggestions();
          showNotification('Address selected');
        });
        suggestionsEl.appendChild(suggestionEl);
      });
      
      container.appendChild(suggestionsEl);
    }

    // Hide address suggestions
    function hideAddressSuggestions() {
      const existingSuggestions = document.querySelector('.address-suggestions');
      if (existingSuggestions) {
        existingSuggestions.remove();
      }
    }

    // Get address from coordinates (reverse geocoding)
    function getAddressFromCoords(lat, lng) {
      return fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
        .then(response => response.json())
        .then(data => {
          if (data && data.display_name) {
            return data.display_name;
          }
          throw new Error('No address found');
        });
    }

    // Set POI as destination
    function setAsDestination(poiId) {
      const poi = POIS.find(p => p.id === poiId);
      if (poi) {
        document.getElementById('routeTo').value = poi.name;
        updateClearButtonVisibility('routeTo', 'clearToBtn');
        window.currentDestination = { 
          lat: poi.lat, 
          lng: poi.lng,
          name: poi.name
        };
        showNotification(`"${poi.name}" set as destination`);
        
        // Scroll to routing section
        document.querySelector('.routing-section').scrollIntoView({ 
          behavior: 'smooth',
          block: 'nearest'
        });
      }
    }

    // Find route function
    function findRoute() {
      const fromInput = document.getElementById('routeFrom').value.trim();
      const toInput = document.getElementById('routeTo').value.trim();

      if (!fromInput) {
        showNotification('Please set your starting location', 'error');
        return;
      }

      if (!toInput) {
        showNotification('Please select a destination', 'error');
        return;
      }

      // If we don't have coordinates for the starting point, geocode the address
      if (!window.currentLocation && fromInput) {
        const loading = showLoading('Finding your starting location...');
        
        // Search all over India, not just West Bengal
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fromInput + ', India')}&limit=1`)
          .then(response => response.json())
          .then(data => {
            hideLoading();
            if (data && data.length > 0) {
              window.currentLocation = {
                lat: parseFloat(data[0].lat),
                lng: parseFloat(data[0].lon)
              };
              showRoutePreview();
            } else {
              showNotification('Could not find the starting address. Please try again.', 'error');
            }
          })
          .catch(error => {
            hideLoading();
            showNotification('Error finding your starting location', 'error');
          });
      } else {
        showRoutePreview();
      }
    }

    // Show route preview in the upper right corner
    function showRoutePreview() {
      // Show the route preview container
      document.getElementById('routePreviewContainer').classList.add('active');
      document.getElementById('clearRoute').style.display = 'block';
      
      // Clear any existing preview map
      const previewContainer = document.getElementById('routePreview');
      previewContainer.innerHTML = '';
      
      // Create a new map container
      const mapDiv = document.createElement('div');
      mapDiv.className = 'route-preview-map';
      mapDiv.id = 'routePreviewMap';
      previewContainer.appendChild(mapDiv);
      
      // Initialize the preview map
      routePreviewMap = L.map('routePreviewMap', {
        zoomControl: false,
        attributionControl: false
      });
      
      // Add a tile layer to the preview map
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(routePreviewMap);
      
      // Add markers for start and destination
      const startIcon = L.divIcon({
        className: 'preview-start-marker',
        html: '<div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5)"></div>',
        iconSize: [12, 12]
      });
      
      const endIcon = L.divIcon({
        className: 'preview-end-marker',
        html: '<div style="background:#ef4444;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5)"></div>',
        iconSize: [12, 12]
      });
      
      L.marker([window.currentLocation.lat, window.currentLocation.lng], {icon: startIcon})
        .bindPopup('Start')
        .addTo(routePreviewMap);
      
      L.marker([window.currentDestination.lat, window.currentDestination.lng], {icon: endIcon})
        .bindPopup('Destination')
        .addTo(routePreviewMap);
      
      // Fit the map to show all points
      const bounds = L.latLngBounds([
        [window.currentLocation.lat, window.currentLocation.lng],
        [window.currentDestination.lat, window.currentDestination.lng]
      ]);
      
      routePreviewMap.fitBounds(bounds, { padding: [10, 10] });
      
      showNotification('Route preview created');
    }

    // Clear route function
    function clearRoute() {
      // Hide route preview
      document.getElementById('routePreviewContainer').classList.remove('active');
      document.getElementById('clearRoute').style.display = 'none';
      document.getElementById('routeTo').value = '';
      updateClearButtonVisibility('routeTo', 'clearToBtn');
      window.currentDestination = null;
      
      showNotification('Route cleared');
    }

    // Open route in Google Maps
    function openInGoogleMaps() {
      if (!window.currentLocation || !window.currentDestination) {
        showNotification('No route calculated to open in maps', 'error');
        return;
      }
      
      const fromLat = window.currentLocation.lat;
      const fromLng = window.currentLocation.lng;
      const toLat = window.currentDestination.lat;
      const toLng = window.currentDestination.lng;
      
      // Create Google Maps URL
      const googleMapsUrl = `https://www.google.com/maps/dir/${fromLat},${fromLng}/${toLat},${toLng}`;
      
      // Open in new tab
      window.open(googleMapsUrl, '_blank');
    }

    // Entrance animation for map
    document.getElementById('map').style.opacity = 0;
    setTimeout(()=>{
      document.getElementById('map').style.transition='opacity 800ms ease';
      document.getElementById('map').style.opacity=1;
    },350);

    // Load district boundaries after a short delay
    setTimeout(() => {
      loadDistrictBoundaries();
    }, 1000);

    // Initialize routing
    initRouting();

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      @keyframes slideInDown {
        from { transform: translate(-50%, -100%); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
      }
      @keyframes slideOutUp {
        from { transform: translate(-50%, 0); opacity: 1; }
        to { transform: translate(-50%, -100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    // Make functions available globally for popup buttons
    window.filterByDistrict = filterByDistrict;
    window.handleImageError = handleImageError;
    window.setAsDestination = setAsDestination;
  </script>
</body>
</html>